<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTA - Profile</title>

<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial; }
    body {
        background:url("assets/background.jpg") no-repeat center center fixed;
        background-size:cover;
        min-height:100vh;
        color:white;
    }

    .navbar {
        width:100%;
        padding:25px 60px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        background:rgba(0,0,0,0.35);
        backdrop-filter:blur(10px);
        position:sticky;
        top:0;
        z-index:999;
    }

    nav a { margin-left:25px; color:white; text-decoration:none; font-size:17px; }
    nav a:hover { color:#ff5050; }

    .btn-login { border:1px solid white; padding:8px 18px; border-radius:6px; }
    .btn-login:hover { background:#ff5050; }

    .account-btn { display:none; margin-left:25px; cursor:pointer; }

    .dropdown {
        position:absolute; right:0; top:50px;
        width:160px; flex-direction:column; display:none;
        background:rgba(0,0,0,0.7);
        padding:10px 0; border-radius:8px;
    }
    .dropdown a { padding:10px 22px; color:white; }

    /* Profile Card */
    .profile-card {
        width:420px;
        margin:120px auto;
        background:rgba(0,0,0,0.55);
        backdrop-filter:blur(10px);
        padding:25px;
        border-radius:12px;
        text-align:center;
    }

    .pfp {
        width:120px; height:120px;
        border-radius:50%;
        object-fit:cover;
        border:3px solid white;
        cursor:pointer;
        margin-bottom:10px;
    }

    input, textarea {
        width:100%; padding:12px;
        background:rgba(255,255,255,0.15);
        border:none; border-radius:6px;
        margin-top:10px;
        color:white;
        outline:none;
        font-size:16px;
    }

    textarea { height:90px; resize:none; }

    .btn {
        width:100%; padding:12px;
        background:#ff5050;
        border:none; border-radius:6px;
        color:white; font-size:17px;
        margin-top:10px; cursor:pointer;
    }

    .btn:hover { background:#ff2e2e; }
    .danger { background:#d43535 !important; }
    .danger:hover { background:#a81212 !important; }
</style>
</head>

<body>

<header class="navbar">
    <div class="logo">ZTA</div>

    <nav>
        <a href="index.html">About Me</a>
        <a href="gallery.html">Gallery</a>
        <a href="mission.html">Mission</a>
        <a href="shop.html">Gear</a>
        <a href="contact.html">Contact</a>

        <a href="auth.html" id="loginBtn" class="btn-login">Login</a>
        <span id="accountBtn" class="account-btn">Account â–¼</span>

        <div id="dropdownMenu" class="dropdown">
            <a href="dashboard.html">Dashboard</a>
            <a href="profile.html">Profile</a>
            <a href="#" onclick="logoutUser()">Logout</a>
        </div>
    </nav>
</header>

<div class="profile-card">

    <img id="profilePic" class="pfp" src="assets/default-pfp.png" onclick="uploadPFP()">

    <h2 id="profileUsername">Username</h2>
    <p id="profileEmail" style="opacity:0.8; font-size:14px;">email@example.com</p>
    <p id="createdDateText" style="opacity:0.7; font-size:13px;">Created: --</p>
    <p id="lastLoginText" style="opacity:0.7; font-size:13px;">Last Login: --</p>

    <textarea id="bioInput" placeholder="Write something about yourself..."></textarea>

    <button class="btn" onclick="saveProfile()">Save Profile</button>
    <button class="btn" onclick="downloadUser()">Download My Data (JSON)</button>
    <button class="btn danger" onclick="deleteAccount()">Delete Account</button>

</div>

<!-- FIREBASE SCRIPTS -->
<script type="module">

import { auth, db, storage } from "./firebase.js";

import {
    onAuthStateChanged,
    deleteUser,
    signOut
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import {
    doc,
    getDoc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
    ref,
    uploadBytes,
    getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

/* -----------------------------
    LOAD USER DATA
----------------------------- */
onAuthStateChanged(auth, async (user) => {

    if (!user) {
        alert("Login required!");
        window.location.href = "auth.html";
        return;
    }

    document.getElementById("profileEmail").innerText = user.email;

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
        const data = snap.data();
        document.getElementById("profileUsername").innerText = data.username;
        document.getElementById("bioInput").value = data.bio || "";
        document.getElementById("createdDateText").innerText = "Created: " + (data.created || "--");
        document.getElementById("lastLoginText").innerText = "Last Login: " + (data.lastLogin || "--");

        if (data.pfpUrl) {
            document.getElementById("profilePic").src = data.pfpUrl;
        }
    }
});

/* -----------------------------
    UPLOAD PROFILE PHOTO
----------------------------- */
window.uploadPFP = function () {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";

    input.onchange = async () => {
        const file = input.files[0];
        const user = auth.currentUser;

        const storageRef = ref(storage, "pfp/" + user.uid + ".jpg");
        await uploadBytes(storageRef, file);

        const url = await getDownloadURL(storageRef);

        await updateDoc(doc(db, "users", user.uid), { pfpUrl: url });

        document.getElementById("profilePic").src = url;
        alert("Profile picture updated!");
    };

    input.click();
};

/* -----------------------------
    SAVE BIO
----------------------------- */
window.saveProfile = async function () {
    const user = auth.currentUser;
    const bio = document.getElementById("bioInput").value;

    await updateDoc(doc(db, "users", user.uid), { bio });
    alert("Profile updated!");
};

/* -----------------------------
    DOWNLOAD USER JSON
----------------------------- */
window.downloadUser = async function () {
    const user = auth.currentUser;
    const snap = await getDoc(doc(db, "users", user.uid));

    const blob = new Blob([JSON.stringify(snap.data(), null, 2)], {
        type: "application/json"
    });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "zta_user.json";
    a.click();
};

/* -----------------------------
    DELETE ACCOUNT
----------------------------- */
window.deleteAccount = async function () {

    if (!confirm("Are you sure you want to permanently delete your account?"))
        return;

    const user = auth.currentUser;

    await deleteUser(user);

    alert("Account deleted.");
    window.location.href = "auth.html";
};

/* -----------------------------
    LOGOUT
----------------------------- */
window.logoutUser = function () {
    signOut(auth);
    window.location.href = "auth.html";
};
</script>

</body>
</html>
