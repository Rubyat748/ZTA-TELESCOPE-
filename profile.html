<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTA - Profile</title>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body {
        background: url("assets/background.jpg") no-repeat center center fixed;
        background-size: cover;
        min-height: 100vh; color: white; overflow-x: hidden;
    }

    /* NAVBAR */
    .navbar { width: 100%; padding: 25px 60px; display: flex; justify-content: space-between;
        align-items: center; backdrop-filter: blur(10px); background: rgba(0,0,0,0.35);
        position: sticky; top: 0; z-index: 999;
    }
    .logo { font-size: 32px; font-weight: bold; letter-spacing: 3px; }
    nav { display: flex; align-items: center; position: relative; }
    nav a { margin-left: 25px; text-decoration: none; color: #fff; font-size: 17px; transition: 0.3s; }
    nav a:hover { color: #ff5050; }
    .btn-login { padding: 8px 18px; border: 1px solid #fff; border-radius: 6px; margin-left: 20px; }
    .btn-login:hover { background: #ff5050; }
    .account-btn { margin-left: 25px; cursor: pointer; font-size: 17px; color: white; display: none; }
    .dropdown {
        position: absolute; top: 45px; right: 0; width: 160px; background: rgba(0,0,0,0.7);
        backdrop-filter: blur(12px); border-radius: 8px; padding: 10px 0; display: none;
        flex-direction: column; opacity: 0; transform: translateY(-10px); transition: .25s;
    }
    .dropdown a { padding: 10px 22px; text-decoration: none; color: white; font-size: 15px; }
    .dropdown a:hover { background: rgba(255, 80, 80, 0.35); }

    /* PROFILE CARD */
    .profile-card {
        width: 420px; margin: 110px auto; background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);
        padding: 25px; border-radius: 12px; text-align: center;
    }

    .pfp {
        width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
        border: 3px solid white; cursor: pointer; margin-bottom: 10px;
    }

    input, textarea {
        width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 12px;
        border-radius: 6px; border: none; font-size: 16px; outline: none;
    }
    textarea { height: 85px; resize: none; }

    .btn {
        width: 100%; padding: 12px; background: #ff5050; color: white;
        border: none; border-radius: 6px; font-size: 17px; cursor: pointer; margin-top: 10px;
    }
    .btn:hover { background: #ff2e2e; }

    .danger { background: #d43535 !important; }
    .danger:hover { background: #a81212 !important; }
</style>
</head>

<body>

<header class="navbar">
    <div class="logo">ZTA</div>

    <nav>
        <a href="index.html">About Me</a>
        <a href="gallery.html">Gallery</a>
        <a href="mission.html">Mission</a>
        <a href="shop.html">Gear</a>
        <a href="contact.html">Contact</a>

        <a href="auth.html" class="btn-login" id="loginBtn">Login</a>
        <span class="account-btn" id="accountBtn">Account â–¼</span>

        <div class="dropdown" id="dropdownMenu">
            <a href="dashboard.html">Dashboard</a>
            <a href="profile.html">Profile</a>
            <a href="#" onclick="logoutUser()">Logout</a>
        </div>
    </nav>
</header>

<div class="profile-card">

    <img id="profilePic" class="pfp" src="assets/default-pfp.png" alt="Profile Picture" onclick="uploadPFP()">

    <h2 id="profileUsername">Username</h2>
    <p id="profileEmail" style="opacity:0.8; font-size:14px;">email@example.com</p>
    <p style="opacity:0.7; font-size:13px;" id="createdDateText">Created: --</p>
    <p style="opacity:0.7; font-size:13px;" id="lastLoginText">Last Login: --</p>

    <textarea id="bioInput" placeholder="Write something about yourself..."></textarea>

    <button class="btn" onclick="saveProfile()">Save Profile</button>
    <button class="btn" onclick="downloadUser()">Download My Data (JSON)</button>
    <button class="btn danger" onclick="deleteAccount()">Delete Account</button>

</div>

<!-- FIREBASE -->
<script type="module">

import { auth, db, storage } from "./firebase.js";
import { 
    onAuthStateChanged, 
    updateProfile, 
    deleteUser,
    signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import { 
    doc, 
    getDoc, 
    updateDoc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import { 
    ref, 
    uploadBytes, 
    getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

/* ==========================
   LOAD USER DATA
========================== */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        alert("Login required!");
        window.location.href = "auth.html";
        return;
    }

    document.getElementById("profileEmail").innerText = user.email;

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
        let data = snap.data();
        document.getElementById("profileUsername").innerText = data.username;
        document.getElementById("bioInput").value = data.bio || "";
        document.getElementById("createdDateText").innerText = "Created: " + (data.created || "--");
        document.getElementById("lastLoginText").innerText = "Last Login: " + (data.lastLogin || "--");

        if (data.pfpUrl) {
            document.getElementById("profilePic").src = data.pfpUrl;
        }
    }
});

/* ==========================
   UPLOAD PFP
========================== */
window.uploadPFP = function () {
    let input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";

    input.onchange = async () => {
        let file = input.files[0];
        const user = auth.currentUser;

        const storageRef = ref(storage, "pfp/" + user.uid + ".jpg");
        await uploadBytes(storageRef, file);

        const url = await getDownloadURL(storageRef);

        await updateDoc(doc(db, "users", user.uid), { pfpUrl: url });

        document.getElementById("profilePic").src = url;
        alert("Profile picture updated!");
    };

    input.click();
};

/* ==========================
   SAVE PROFILE
========================== */
window.saveProfile = async function () {
    const user = auth.currentUser;
    const bio = document.getElementById("bioInput").value;

    await updateDoc(doc(db, "users", user.uid), { bio: bio });
    alert("Profile updated!");
};

/* ==========================
   DOWNLOAD USER DATA
========================== */
window.downloadUser = async function () {
    const user = auth.currentUser;
    const snap = await getDoc(doc(db, "users", user.uid));

    const blob = new Blob([JSON.stringify(snap.data(), null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "zta_user.json";
    a.click();
};

/* ==========================
   DELETE ACCOUNT
========================== */
window.deleteAccount = async function () {
    if (!confirm("Delete account permanently?")) return;

    const user = auth.currentUser;
    await deleteUser(user);

    alert("Account deleted.");
    window.location.href = "auth.html";
};

/* ==========================
   LOGOUT
========================== */
window.logoutUser = function () {
    signOut(auth);
    window.location.href = "auth.html";
};
</script>

</body>
</html>
